# 关于 PieDataCS 云原生平台

PieDataCS 云原生平台是一款以 PieCloudDB 为核心的可视化数据库管理平台，它用于管理部署实例上所拥有的实体物理资源，例如 CPU、内存、存储等。这些部署实例可以运行在物理硬件、容器或者虚拟机上。

在 PieDataCS 云原生平台注册账号成功后，系统会自动为初始用户创建一个组织以及该组织下的数仓。作为组织管理员，初始用户可以在「**控制台**」页面查看数仓列表信息，并支持在数仓下创建新用户，这些新用户将获得相应数仓的访问权限。用户在进入指定的“数仓”页面后，可以根据需求在「**虚拟数仓**」页面创建多个虚拟数仓。在数仓的「**数据洞察**」页面指定虚拟数仓和数据库之后，用户就可以运行 SQL 查询或执行 DML 操作来进行数据交互。

## 系统架构概览

PieDataCS 云原生平台的整体系统架构如下图所示。

<img src="https://pdb-doc.oss-cn-beijing.aliyuncs.com/coc-pic/v1/platform-arch.png" scope="external" />

PieDataCS 云原生平台将部署实例上所拥有的实体物理资源（如 CPU、内存、存储等）集合称为计算空间（Account）。对于 PieCloudDB，一个计算空间实质为一个物理数据仓库（简称数仓）。计算空间隶属于组织，并通过控制台进行统一管理。

控制台既是用户中心，负责管理组织下的所有用户，也具备计算空间的管理功能，同时还包括计费、充值等需要在组织层级控制的其他功能。

一个组织可以对应一个实体（个人、公司或其他组织），并且可以包含多个数仓。每个数仓都会同步建立对应的计算空间。组织下的用户可以加入不同的计算空间并进入数仓，从而在数仓中创建和使用各自的计算资源，即虚拟数仓。

每个数仓可以创建和管理多个虚拟数仓、数据库、用户和角色等。同一组织下各个数仓产生的所有存储和计算费用，都会以组织为单位进行结算。

## 云原生虚拟数仓相关概念
### PieCloudDB 实例

数据库实例（Database Instance）是由操作系统进程和相关资源组成的独立且运行中的数据库环境。它可以被视为一个完整的、具有独立身份和特定功能的数据库系统，其中包括数据文件、日志文件、缓存区、网络端口等多个组件。

PieCloudDB 实例指的是已经安装完成的任意版本的 PieCloudDB 产品，它可以在物理硬件、容器或虚拟机上运行。无论其底层载体是什么，都可以被视为一个实例。例如，用户可以在自己的 K8s 集群上部署一套 PieCloudDB 实例，也可以在阿里云上部署一套 PieCloudDB 实例。用户通过访问 PieCloudDB 实例来获取数据库服务。

### 数仓

数据仓库，即数仓，是一种专门化的数据库系统，用于存储和管理企业级数据。它是一个集成数据的中央存储库，汇集了来自一个或多个不同源的数据。数据仓库将当前和历史数据存储在一起，用于为整个企业的员工创建分析报告。与传统的事务处理型数据库不同，数据仓库着重于数据的分析、报告和智能决策。数仓的主要特点包括：

* 面向主题：数据仓库以企业或组织为中心，按照业务领域或主题对数据进行组织和存储。这样的组织结构不仅更符合业务需求，也便于数据的查询、分析和统计。
* 集成性强：数据仓库通常汇集来自多个不同来源和系统的数据，通过对数据进行提取、转换和加载，实现数据的集成和统一管理。
* 时间性：数据仓库通常包含历史数据和当前数据，可以追溯数据的历史变化和趋势，支持时间序列分析和预测模型的建立与应用。
* 面向决策：数据仓库中的数据经过清洗、整理和加工，转化为更适合决策分析和报表统计的形式。可以通过 OLAP（Online Analytical Processing）等技术进行复杂查询和多维分析，为企业决策提供有力支持。

### 虚拟数仓

虚拟数据仓库（Virtual Data Warehouse），即虚拟数仓，是一种基于数据虚拟化技术的数据管理解决方案。它通过抽象化数据源和数据存储之间的逻辑关系，实现对分散、异构数据的整合和管理。虚拟数仓提供了统一的数据视图和访问接口，满足企业级应用和分析需求。虚拟数仓代表纯计算资源，是动态的，包括由后台云上的虚拟机提供的 CPU、内存和临时存储的计算资源集群。

虚拟数仓中不存储真实数据，仅提供 SQL 执行服务。一个虚拟数仓至少包括一个协调器和一个执行器，每个节点都是一组 CPU、内存和磁盘资源的虚拟资源集合。用户无法直接获取这些节点的信息，但对有权限的用户来说，虚拟数仓的启动、停止、扩展和缩减过程是可见的。

协调器负责响应客户端的 SQL 请求，生成查询计划，分发执行信息和元数据，并执行最终结果的汇总（如 LIMIT、ORDER BY 等）。每个集群有一个且只有一个协调器，通常只有协调器对用户可见，而执行器对用户不可见。但在某些特殊场景下，客户端也可能直接访问执行器。

执行器用于执行协调器分发的任务。每个集群可以有一个或多个执行器，它们可以并行执行同一个 SQL 查询任务。

### 组织

一个组织可以对应一个实体，无论是个人、公司还是其他组织形式，并且可以包含多个数仓。每个数仓都会同步建立其对应的计算空间。在一个组织下，可以有多个用户，这些用户可以加入不同的计算空间并进入数仓，并在数仓中创建和使用他们各自的计算资源，即虚拟数仓。

每个数仓能够创建和管理多个虚拟数仓、数据库、用户和角色等。同一组织下各个数仓产生的所有存储和计算费用，都将以组织为单位进行统一结算。

### 用户

用户（User）是指隶属于组织的用户，他们可以加入不同的计算空间。在同一个计算空间下，所有用户共享该计算空间的资源。

PieDataCS 云原生平台的控制台和计算空间（数仓）各自拥有一套独立的权限管理体系和用户功能。用户可以先加入组织，然后再申请加入计算空间，或者直接在计算空间下创建新用户。用户可使用的系统功能和 PieCloudDB 数据库权限取决于他们各自角色的权限设置。计算空间所对应数仓下的用户功能允许查看当前数仓下所有用户的激活和审核状态。拥有用户管理权限的用户可以执行新增、删除、修改用户等操作。用户通过邮箱或手机号码进行身份区分，一个邮箱地址或手机号码仅对应一个用户。

### 角色

角色（Role）是系统和数仓（计算空间）中用于分配数据库权限的一种机制，代表了一个权限的集合。权限通过角色这个载体下放给用户，一个角色可以对应一个用户，也可以对应一类用户。用户与角色之间的关系不是一一对应的，也就是说，一个用户可以被授予多个角色，而一个角色也可以被授予给多个用户。每个用户至少会被赋予一种角色，而每一种角色都有其对应的权限集。

## 版本差异性说明

PieDataCS 云原生平台为 PieCloudDB 数据库内核提供了数据洞察、元数据浏览、用户管理、权限管理、SQL 查询历史、ETL 管理等功能的可视化界面，使用户能够通过直观的操作与 PieCloudDB 内核进行交互。

PieDataCS 云原生平台支持企业版和云上云版，两者在功能上存在差异，包括但不限于：

* 用户登录方式不同。

  PieDataCS 云原生平台企业版的登录信息可由部署之后显示的打印信息获取，而对于云上云版，用户登录 OpenPie 官网（https://www.openpie.com/product-version#coc）即可进入产品界面。

* 虚拟数仓的外部接入方式不同。

  云上云版的虚拟数仓仅支持 PieProxy 作为外部接入方式，而企业版则提供了 Node Port 和 PieProxy 两种选项。在企业版中，默认的外部接入方式为 Node Port。
  
* 云上云版独有功能如下：
  * 计费模式
  * 费用中心
  * 我的工单
  * 免费试用
  * 用量统计

* 企业版独有功能如下：
  * 定时任务
  * 审计日志
  * 数据脱敏
  * FDW
  * 数据集成
