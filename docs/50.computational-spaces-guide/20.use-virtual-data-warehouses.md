# 虚拟数仓

虚拟数仓是计算空间（数仓）内可按需创建的极具弹性的计算资源，它用于提供数据计算服务。在使用 PieCloudDB 运行 SQL 查询或 DML 操作之前，用户需要先指定一个虚拟数仓和数据库。之后，相应的 SQL 任务将通过指定的虚拟数仓与指定数据库中的数据进行交互。

由于 PieCloudDB 采用存算分离的架构，即使不同的虚拟数仓访问的是同一份数据，每个虚拟数仓的计算资源也是相互隔离的。因此，任何一个虚拟数仓与存储层的交互、启动、停止或扩缩容操作都不会影响其他虚拟数仓的计算性能。用户可以根据自己的计算需求，创建、启动、停止或调整虚拟数仓的资源规格。

在计算空间操作界面，具有相应管理权限的用户（例如数仓管理员和数据库管理员）点击菜单栏中的 **虚拟数仓** 即可进入功能页面。该页面主要支持如下操作：

* 创建虚拟数仓
* 删除虚拟数仓
* 启停虚拟数仓
* 修改虚拟数仓配置
* 虚拟数仓的扩缩容
* 配置外部接入
* 查看虚拟数仓详情

## 创建虚拟数仓

一个 PieCloudDB 数仓下可根据需求创建多个虚拟数仓。创建虚拟数仓的具体操作步骤如下：

1. 在「**虚拟数仓**」页面点击 **新建虚拟数仓**，进入虚拟数仓创建页面。
2. 输入虚拟数仓的名称，并选择执行节点数量和节点规格。

   如下示例为，创建一个名称为“vw1”，且拥有“4”个“标准”规格（即 2C4G）执行器的虚拟数仓。

   <img src="https://pdb-doc.oss-cn-beijing.aliyuncs.com/coc-pic/v1/create-vdw.png" scope="external" />

    <note type="tip">
       <p>当前 PieCloudDB 默认只支持标准的节点规格，但用户可根据业务场景联系 OpenPie 定制虚拟数仓的规格。</p>   
    </note>
   
3. （可选）设置虚拟数仓的自动启停功能并按需设置自动关闭等待时长。

    “高级配置”选项用于设置虚拟数仓的自动启停功能，该功能需要在部署时手动开启。

    * 如果打开“自动启动”功能，则当虚拟数仓处于关闭状态而用户尝试运行查询命令、数据导入、外部接入等功能时，虚拟数仓会自动启动并运行相关任务。
    
    * 如果打开“自动关闭”功能，当虚拟数仓在没有运行任务时，会等待至所设置的“自动关闭等待时长”后自动关闭。系统默认的自动关闭等待时长为 10 分钟。

    <img src="https://pdb-doc.oss-cn-beijing.aliyuncs.com/coc-pic/v1/vw-advanced-options.png" scope="external" />

    <note type="tip">
      <p>PieDataCS 云原生平台的云上云版本默认开启自动启停功能。</p>   
    </note>

4. 点击 **确认**，一个新的虚拟数仓即创建完成并同步到虚拟数仓列表中。

## 删除虚拟数仓

虚拟数仓支持删除操作。如果需要删除一个虚拟数仓，用户可以在「**虚拟数仓**」页面的虚拟数仓列表中选中目标虚拟数仓，然后点击隐藏菜单栏「…」并选择 **删除** 选项，即可删除该虚拟数仓。但需要注意，一旦虚拟数仓被删除，它将无法被恢复。

<img src="https://pdb-doc.oss-cn-beijing.aliyuncs.com/coc-pic/v1/delete-vdw.png" scope="external" />

## 启停虚拟数仓

在 PieCloudDB 数仓下，用户可以根据需求开启多个虚拟数仓。每个虚拟数仓都支持手动启动和关闭。此外，如果虚拟数仓出现状态异常，系统还提供了强制关闭操作的选项。

在「**虚拟数仓**」页面的虚拟数仓列表中选中目标虚拟数仓，然后点击隐藏菜单栏「…」并选择相应的启停操作。

* 当虚拟数仓处于“运行中”状态时，点击 **关闭** 选项，即可关闭运行中的虚拟数仓。

   <img src="https://pdb-doc.oss-cn-beijing.aliyuncs.com/coc-pic/v1/shutdown-vdw.png" scope="external" />

* 当虚拟数仓处于“已关闭”状态时，点击 **启动** 选项，即可启动已关闭的虚拟数仓。

   <img src="https://pdb-doc.oss-cn-beijing.aliyuncs.com/coc-pic/v1/startup-vdw.png" scope="external" />

* 当虚拟数仓处于“失败”、“关闭中”或者“启动中”状态时，点击 **强制关闭** 选项，即可强制关闭该虚拟数仓。

   <img src="https://pdb-doc.oss-cn-beijing.aliyuncs.com/coc-pic/v1/force-shutdown-vdw.png" scope="external" />

## 修改虚拟数仓配置

在「**虚拟数仓**」页面的虚拟数仓列表中，用户选择目标虚拟数仓并点击隐藏菜单「…」，然后选择 **修改** 选项，即可进入目标虚拟数仓的配置界面。

<img src="https://pdb-doc.oss-cn-beijing.aliyuncs.com/coc-pic/v1/scale-vdw.png" scope="external" />

虚拟数仓支持修改基本配置和高级配置。当虚拟数仓处于“运行中”或“已关闭”状态时，包括虚拟数仓名称、执行器数量、规格、备注、自动启停项等在内的配置项均支持修改。

## 虚拟数仓的扩缩容

虚拟数仓可以根据用户需求，通过增加或减少执行器的数量来实现扩容（Scale Out）或缩容（Scale In）。通过这种方式，虚拟数仓中的协调器可以保持不变，即用户在完成虚拟数仓的扩缩容操作后，执行查询任务时与执行器相交互的协调器与扩缩容操作前是相同的。

下图展示了虚拟数仓通过增加执行器数量进行扩容的过程。

<img src="https://pdb-doc.oss-cn-beijing.aliyuncs.com/pdb-admin-guide-ap/scale-out.png" scope="external" />

下图展示了虚拟数仓通过减少执行器数量进行缩容的过程。

<img src="https://pdb-doc.oss-cn-beijing.aliyuncs.com/pdb-admin-guide-ap/scale-down.png" scope="external" />

当虚拟数仓处于“已关闭”或“运行中”状态时，可以通过修改执行器（节点）数量来实现扩缩容。

在「**虚拟数仓**」页面的虚拟数仓列表中，选择目标虚拟数仓并点击隐藏菜单「…」，然后选择 **修改** 选项，即可进入目标虚拟数仓的配置界面。

在虚拟数仓的配置页面，用户可以通过减少执行节点的数量来执行缩容操作。例如，将节点数量从“4”调整为“2”。一旦确认变更，设置会立即生效，从而将虚拟数仓的执行器数量从 4 个缩容到 2 个。

<img src="https://pdb-doc.oss-cn-beijing.aliyuncs.com/coc-pic/v1/scale-in1.png" scope="external" />

同理，用户可以通过增加虚拟数仓的执行节点数量来执行扩容操作。

此外，在新建虚拟数仓或者修改虚拟数仓配置时，用户还可以根据业务需求，通过配置不同的虚拟数仓规格来实现扩缩容（Scale Out/In）。不同的数仓规格对应不同的协调器和执行器资源配额设置，包括标准和中等两个等级，这对应不同的 CPU 和内存配置。

## 查看虚拟数仓详情

在「**虚拟数仓**」页面的虚拟数仓列表中，用户选择目标虚拟数仓并点击 **查看详情** 即可进入指定虚拟数仓的详情页面。

<img src="https://pdb-doc.oss-cn-beijing.aliyuncs.com/coc-pic/v1/vdw-details.png" scope="external" />

该页面主要展示指定虚拟数仓的如下信息：
* 启停记录
* 错误日志
* SQL 审计日志
  
* 用户的查询信息
  
  <note type="tip">
    <p>仅 PieDataCS 云原生平台的企业版支持此功能。</p>   
  </note>

* 用户的会话信息 

  <note type="tip">
    <p>仅 PieDataCS 云原生平台的企业版支持此功能。</p>   
  </note>

### 启停记录

**启停记录**功能以列表形式展示虚拟数仓的启动和关闭历史，方便用户监控和审查虚拟数仓的运行状态。

启停记录列表通常包含以下字段信息：

* 名称：虚拟数仓的名称。
* ID：虚拟数仓的 ID。
* 执行节点数量：虚拟数仓在关闭前所配置的执行节点数量。
* 规格：虚拟数仓的规格类型。
* 启动时间：虚拟数仓的启动时间。
* 关闭时间：虚拟数仓的关闭时间。
* 停止原因，即虚拟数仓关闭的原因，可能为如下之一：
   * 用户关闭：用户手动关闭虚拟数仓。 
   * 自动关闭：虚拟数仓开启“自动关闭”开关后，在没有任务运行时，等待至“自动关闭等待时长”后将自动关闭。
   * 数仓冻结：虚拟数仓所属的数仓被冻结，无法使用。
   * 用户修改：用户手动修改了虚拟数仓的配置而触发关闭，待修改生效后，虚拟数仓会自动启动。
* 运行时间：虚拟数仓由启动到关闭的时间间隔。

### 错误日志

<note type="attention">
      <p> 安装 Monitor 模块后，即可开通 PieDataCS 云原生平台的虚拟数仓的错误日志功能。</p>   
</note>

**错误日志**功能以列表形式展示虚拟数仓的错误日志信息，帮助用户更有效地定位和解决相关问题。

错误日志信息列表通常包含以下字段信息：
* 日志级别：日志级别从轻到重分别为 ERROR、FATAL 和 PANIC，默认显示全部级别的日志信息。
* 节点名称：节点类型，包括协调节点（coordinator）和执行节点（executor）。
* 日志内容：日志的详细信息。
* 时间：日志的生成时间。

错误日志信息列表提供如下快捷操作：
* 根据日志级别筛选日志：使用**日志级别**控件可以筛选出指定的一个或多个日志级别的日志信息。默认情况下，展示所有日志级别的历史信息。
* 根据节点类型筛选日志：通过**节点类型**下拉列表中选择特定的节点类型，可以筛选出相应节点类型的日志信息。默认情况下，显示所有节点类型的错误日志。
* 指定时间范围筛选日志：使用**开始时间-结束时间**控件可以指定只显示某个时间范围内的日志信息。
* 根据日志级别排序：使用**排序方式**控件可以根据日志级别对日志信息进行正序或者倒序排列。

### SQL 审计

<note type="attention">
      <p> 安装 Monitor 模块后，即可开通 PieDataCS 云原生平台的虚拟数仓的 SQL 审计功能。</p>   
</note>

**SQL 审计**功能以列表形式记录并监控在虚拟数仓中执行的所有 SQL 操作。要使用此 SQL 审计功能，用户需要在虚拟数仓列表中启用审计开关。

SQL 审计列表通常包含以下字段信息：
* 执行用户：使用虚拟数仓执行 SQL 的用户名称。
* 虚拟数仓 ID：虚拟数仓的 ID。
* 时间：执行 SQL 的时间。
* 数据库：执行 SQL 的数据库。
* SQL 类别：SQL 语句所属的类别，可能为如下之一：
  * READ：数据源存在关系或查询的命令，包括 SELECT 和 COPY。
  * WRITE：目标数据存在关系的命令，包括 INSERT、UPDATE、DELETE、TRUNCATE 和 COPY。
  * FUNCTION：函数调用和 DO 块。
  * ROLE：与角色和权限相关的语句，包括 GRANT、REVOKE、CREATE/ALTER/DROP ROLE。
  * DDL：ROLE 中未包含的所有 DDL。
  * MISC：杂项命令，例如 DISCARD、FETCH、CHECKPOINT、VACUUM、SET。
  * MISC_SET：杂项 SET 命令，例如 SET ROLE。
  * ALL：包括以上所有内容。
  * none：默认项。
* 命令类型：SQL 命令的类型。
* 会话 ID：执行 SQL 的会话（客户端连接）ID。
* 事务 ID：执行 SQL 的事务 ID。
* SQL 参数：执行的 SQL 里所包含的参数。如果设置了 pgaudit.log_parameter，则此字段将包含引用的 CSV 格式的语句参数，如果没有参数则显示 `<none>`。否则，该字段显示 `<not logged>`。
* SQL 文本：所执行的 SQL 语句的完整内容。

SQL 审计列表提供如下快捷操作：
* 根据 SQL 文本搜索信息：搜索框支持通过 SQL 文本来检索相关的审计信息。
* 指定时间范围筛选信息：使用**开始时间-结束时间**控件可以指定只显示某个时间范围内的 SQL 审计信息。
* 根据执行时间排序：使用**排序方式**控件可以根据执行时间的长短将 SQL 审计信息进行正序或者倒序排列。

### 终止查询

**查询**功能允许用户查看并在需要时终止自己在该虚拟数仓中执行的 SQL 查询。

查询列表默认显示全部用户在当前虚拟数仓正在执行的 SQL 查询，用户选中自己在该虚拟数仓所执行的 SQL 查询后，点击 **终止查询** > **确定** 即可结束该查询任务。

<img src="https://pdb-doc.oss-cn-beijing.aliyuncs.com/pdb-admin-guide-ap/V2.15.0/terminate-query.png" scope="external" />

### 终止会话

**会话**功能支持用户查看和管理自己在该虚拟数仓中发起的会话（客户端连接）。

会话列表默认展示所有用户在当前虚拟数仓中发起的会话。用户可以选中自己发起的特定会话，然后点击 **终止会话** > **确定** 即可结束该会话。一旦会话被终止，其中的所有查询也将随之终止。

<img src="https://pdb-doc.oss-cn-beijing.aliyuncs.com/pdb-admin-guide-ap/V2.15.0/terminate-session.png" scope="external" />

会话列表提供如下快捷操作：
* 根据会话状态筛选会话：通过在**会话状态**下拉列表中选择特定的会话状态，可以筛选出相应状态的会话。默认情况下，显示所有状态的会话。会话状态可能为如下之一：
  * active：会话正在工作中。
  * idle：会话处于空闲状态。
  * idle in transaction：事务正在运行但不活跃，可能正在等待用户输入。
  * idle in transaction (aborted)：与 “idle in transaction” 类似，两者的区别是该状态指示事务中的某条语句导致了事务中止。
  * fastpath function call：会话正在执行一个高效的函数调用。
  * disabled：会话已被关闭。
* 根据用户筛选会话：通过在**用户名**下拉列表中选择特定用户名，可以筛选出相应用户的会话。默认情况下，显示所有用户的会话。
* 按照进程 ID 排序：点击“pid”字段旁边的排序快捷键，可以根据进程 ID 的大小对列表信息进行排序。 
* 按照会话 ID 排序：点击“会话 ID”字段旁边的排序快捷键，可以根据会话 ID 的大小对列表信息进行排序。 
* 按照开始时间排序：点击“开始时间”字段旁边的排序快捷键，可以根据会话开始时间的由近到远或者由远到近的顺序对列表信息进行排序。  

## 配置外部接入

虚拟数仓支持外部接入功能，但需要在部署时手动启用。新建的虚拟数仓默认不开启外部接入的功能。一旦启用该功能，用户在创建虚拟数仓后，可以通过打开外部接入开关来进行连接操作。

<img src="https://pdb-doc.oss-cn-beijing.aliyuncs.com/coc-pic/v1/external-access-vdw.png" scope="external" />

需要注意的是，PieDataCS 云原生平台云上云版的虚拟数仓仅支持 PieProxy 作为外部接入方式，而企业版则提供了 Node Port（默认方式）和 PieProxy 两种选项。说明如下：
* Node Port： 通过每个 Node 上的固定端口号直接访问。
* PieProxy：用户可以通过虚拟数仓使用 JDBC、ODBC 或 Postgres 驱动从外部连接数据库来获取数据。

<!-- 负载均衡（LB）：访问通过负载均衡公网 IP 实现自动分配到各 Node 上的服务。-->

企业版用户可以根据需要更改外部接入的方式。在目标虚拟数仓的“外部接入”操作栏下，选择相应的外部接入选项即可。但只有虚拟数仓处于“已关闭”或“运行中”状态时，才能进行外部接入方式的更改操作。

## 访问虚拟数仓

用户可以通过以下两种方式访问和连接虚拟数仓：

- 通过 WebSQL 的方式连接指定的虚拟数仓来执行 SQL。
- 启用外部接入功能，通过客户端连接虚拟数仓。

### 通过 WebSQL 方式连接虚拟数仓

用户通过数据洞察功能执行 SQL 查询以获取所需结果。在执行 SQL 查询的过程中，还需要连接到指定的数据库和虚拟数仓。

虚拟数仓具备为查询任务分配计算资源的能力。通过指定数据库，可以确保查询操作仅涉及与当前业务相关的数据；同时，指定虚拟数仓可以根据查询需求动态分配计算资源，以确保查询操作的执行不会影响其他任务的性能。

在「**数据洞察**」页面的“文件”面板，点击 **新建 SQL 文件** 快捷按钮，或者点击 **新建 > 新建 SQL 文件**，又或者在左侧的文件管理栏中选择一个已创建的 SQL 文件。打开 SQL 文件后，用户可以通过选择数据库和虚拟数仓来执行 SQL 查询。

<img src="https://pdb-doc.oss-cn-beijing.aliyuncs.com/coc-pic/v1/websql-access-vdw.png" scope="external" />

其中，可选的虚拟数仓状态类型如下：

- 运行中的虚拟数仓。
- 非运行中、非关闭中和非失败状态，但配置了自动启动的虚拟数仓。

上述两种虚拟数仓状态的主要区别在于：当选择的虚拟数仓处于“运行中”状态时，点击 **执行** 会立即执行 SQL 查询；如果选择的虚拟数仓未处于“运行中”状态，但已配置了“自动启动”功能，那么点击 **执行** 会先启动虚拟数仓，随后再执行 SQL 查询。除以上情况外，其他状态的虚拟数仓均不可选。

### 通过客户端连接虚拟数仓

在通过客户端连接虚拟数仓之前，用户首先需要启用目标虚拟数仓的外部接入功能。在成功获取连接信息后，再进行客户端的连接配置。本文以通用的外部接入方式 PieProxy 为例，连接配置的步骤如下：

**第一步：开启 PieProxy 外部接入**

在「**虚拟数仓**」页面的虚拟数仓列表中，找到目标虚拟数仓，并在其外部接入栏下选择“PieProxy”以启动外部接入。成功开启外部接入功能之后，目标虚拟数仓所在列的外部接入栏下就会出现“高级配置”选项。

<img src="https://pdb-doc.oss-cn-beijing.aliyuncs.com/coc-pic/v1/pieproxy-config.png" scope="external" />

目标虚拟数仓的“PieProxy 高级配置”可以用于设置 CIDR 白名单和用户白名单。CIDR 白名单用于限定允许进行外部接入的客户端 IP 地址范围，而用户白名单则用于限定允许进行外部接入的用户范围。如果相应的白名单未设置任何条目，则表示对所有 IP 地址或用户开放访问权限；相反，只有当 IP 地址或用户被列入白名单时，才能访问目标虚拟数仓。

<img src="https://pdb-doc.oss-cn-beijing.aliyuncs.com/coc-pic/v1/PieProxy-advanced-config.png" scope="external" />

**第二步：配置客户端连接**

在「**虚拟数仓**」页面的虚拟数仓列表中，目标虚拟数仓开启 PieProxy 外部接入后，在其“外部接入”栏下点击 **接入详情**，即可查看虚拟数仓的连接信息和连接示例。

<note type="tip">
   <p> 目前支持的客户端工具包括 psql、pgadmin、DBeaver、Navicat（在兼容模式下）等；支持的驱动或封装库包括 pgx、gorm、MyBatis、HikariCP、psycopg2 等。在正常情况下，对于兼容 PostgreSQL V11 及以上版本的客户端工具，外部连接可以同步支持。对于其他版本的客户端工具，可以在外部连接的兼容模式下获得支持。</p>   
</note>

配置客户端的外部连接时一般涉及如下信息：

* 用户连接信息，包括用户名（即登录平台的用户名称）和虚拟数仓 Token 密码。
* 虚拟数仓信息，包括虚拟数仓服务器的接入 IP 地址、端口号和虚拟数仓 ID。
* 数据库信息，一般只需数据库名称即可。

<img src="https://pdb-doc.oss-cn-beijing.aliyuncs.com/coc-pic/v1/pieproxy-details.png" scope="external" />

其中，虚拟数仓的 Token 密码需要通过重置密码的方式获取：首先点击 **忘记了 Token 密码**，然后点击 **重置 Token 密码**。出于安全考虑，PieCloudDB 不会存储此密码，因此用户需要在实时重置后立即记录并保存新密码，或者在每次连接时都进行密码重置操作。

外部接入页面提供了多种连接方式，包括常用的 psql 连接方法、带环境变量的 psql 连接方式，以及一些常用驱动和客户端的连接方法。此外，用户还可以在兼容模式下通过客户端连接到虚拟数仓。这涉及到忽略 PGOPTIONS 配置，并在数据库名称后使用“#”号来附加对应的虚拟数仓 ID。例如，如果需要连接的数据库名为“db1”，虚拟数仓 ID 为“vw1”，则在兼容模式下，连接的数据库名称应为“db1#vw1”。在这种情况下，其他连接参数应与 PostgreSQL 的标准连接方式保持一致。

<note type="attention">
   <p> 如果需要使用 SSL/TSL 连接，用户可以选择自行提供相应的证书，或者申请证书以完成对接。目前，此功能尚未支持界面化操作。如需使用，请联系 OpenPie 获取支持。</p>   
</note>

客户端的默认连接方式分为 Session 模式和 Transaction 模式。其中，Session 模式指的是在客户端连接过程中，会持续占用同一条数据库连接，这便于用户执行连续性或有状态的操作。而 Transaction 模式指的是在客户端连接过程中，多次语句执行可能会使用多条不同的数据库连接，这适合用户执行无状态的操作以及大量并发操作。默认情况下，客户端使用 Session 模式。如果用户希望切换到 Transaction 模式，可以打开“Transaction 模式”按钮，以获取专为Transaction 模式配置的连接信息和示例。

<img src="https://pdb-doc.oss-cn-beijing.aliyuncs.com/coc-pic/v1/transaction-mode.png" scope="external" />

关于更多客户端的外部接入示例，请参见 [外部接入示例](../100.appendix/10.external-access-examples.md)。

### 连接故障排查

1. 问题：客户端通过外部接入连接虚拟数仓，执行 SQL 时报错“prepared statement "stmtcache_XX" does not exist”。

   排查思路：查看使用的连接模式是否是 Transaction 模式，且是否使用到了 Prepared Statement 的语法。或是 Transaction 模式不支持 Prepared Statement 以及 Session 级别的配置设置，建议切换到 Session 模式后再进行尝试。

2. 问题：连接过程中客户端卡住无响应，连接一段时间后发生报错。

   排查思路如下：

   - 查看对应虚拟数仓是否开启或者自动启动的配置是否开启。
   - 查看客户端的并发连接数是否达到上限。默认同用户且同虚拟数仓且同数据库的并发上限为 20，可根据需要进行调整。

3. 问题：客户端配置完成后，在连接虚拟数仓时，发生报错“FATAL: the address from client request is not in the whitelist”。

   排查思路：查看外部接入的客户端 IP 地址是否加入目标虚拟数仓的“PieProxy 高级配置”中的 CIDR 白名单中，只有当客户端 IP 地址被列入白名单时，才能访问目标虚拟数仓。